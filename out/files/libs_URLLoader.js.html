<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>libs/URLLoader.js - Flash2LayaAir API文档</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Flash2LayaAir API文档" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.6</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/annie.Media.html">annie.Media</a></li>
                                <li><a href="../classes/annie.MovieClip.html">annie.MovieClip</a></li>
                                <li><a href="../classes/annie.Shape.html">annie.Shape</a></li>
                                <li><a href="../classes/annie.Sound.html">annie.Sound</a></li>
                                <li><a href="../classes/annie.URLLoader.html">annie.URLLoader</a></li>
                                <li><a href="../classes/annie.Video.html">annie.Video</a></li>
                                <li><a href="../classes/Flash2x.html">Flash2x</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/annie.html">annie</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: libs/URLLoader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var __extends = (this &amp;&amp; this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/**
 * @module annie
 */
var annie;
(function (annie) {
    var EventDispatcher = laya.events.EventDispatcher;
    var Event = laya.events.Event;
    annie.Eval = eval.bind(window);
    /**
     * 资源加载类,后台请求,加载资源和后台交互都可以使用此类
     * @class annie.URLLoader
     * @extends laya.events.EventDispatcher
     * @public
     * @since 1.0.0
     */
    var URLLoader = (function (_super) {
        __extends(URLLoader, _super);
        /**
         * @param type text json js xml image sound css svg video unKnow
         */
        function URLLoader() {
            _super.call(this);
            this.headers = [];
            /**
             * 后台返回来的数据类弄
             * @property responseType
             * @type {string}
             * @default null
             * @public
             * @since 1.0.0
             */
            this.responseType = null;
            /**
             * 请求的url地址
             * @property url
             * @public
             * @since 1.0.0
             * @type {string}
             */
            this.url = &quot;&quot;;
            /**
             * 请求后台的类型 get post
             * @property method
             * @type {string}
             * @default get
             * @public
             * @since 1.0.0
             */
            this.method = &quot;get&quot;;
            /**
             * 需要像后台传送的数据对象
             * @property data
             * @public
             * @since 1.0.0
             * @default null
             * @type {Object}
             */
            this.data = null;
            /**
             * 格式化post请求参数
             * @method _fqs
             * @param data
             * @param query
             * @return {string}
             * @private
             * @since 1.0.0
             */
            this._fqs = function (data, query) {
                var params = [];
                if (data) {
                    for (var n in data) {
                        params.push(encodeURIComponent(n) + &quot;=&quot; + encodeURIComponent(data[n]));
                    }
                }
                if (query) {
                    params = params.concat(query);
                }
                return params.join(&quot;&amp;&quot;);
            };
            //formatURIString
            /**
             * 格式化get 请求参数
             * @method _fus
             * @param src
             * @param data
             * @return {any}
             * @private
             */
            this._fus = function (src, data) {
                var s = this;
                if (data == null || data == &quot;&quot;) {
                    return src;
                }
                var query = [];
                var idx = src.indexOf(&quot;?&quot;);
                if (idx != -1) {
                    var q = src.slice(idx + 1);
                    query = query.concat(q.split(&quot;&amp;&quot;));
                    return src.slice(0, idx) + &quot;?&quot; + s._fqs(data, query);
                }
                else {
                    return src + &quot;?&quot; + s._fqs(data, query);
                }
            };
        }
        /**
         * 取消加载
         * @method loadCancel
         * @public
         * @since 1.0.0
         */
        URLLoader.prototype.loadCancel = function () {
            var s = this;
            if (s._req) {
                s._req.abort();
            }
        };
        /**
         * 加载或请求数据
         * @method load
         * @public
         * @since 1.0.0
         * @param {string} url
         * @param {string} contentType 如果请求类型需要设置主体类型，有form json binary jsonp等，请设置 默认为form
         */
        URLLoader.prototype.load = function (url, contentType) {
            if (contentType === void 0) { contentType = &quot;form&quot;; }
            var s = this;
            s.loadCancel();
            if (s.responseType == null || s.responseType == &quot;&quot;) {
                //看看是什么后缀
                var urlSplit = url.split(&quot;.&quot;);
                var extStr = urlSplit[urlSplit.length - 1];
                var ext = extStr.split(&quot;?&quot;)[0].toLocaleLowerCase();
                if (ext == &quot;mp3&quot; || ext == &quot;ogg&quot; || ext == &quot;wav&quot;) {
                    s.responseType = &quot;sound&quot;;
                }
                else if (ext == &quot;jpg&quot; || ext == &quot;jpeg&quot; || ext == &quot;png&quot; || ext == &quot;gif&quot;) {
                    s.responseType = &quot;image&quot;;
                }
                else if (ext == &quot;css&quot;) {
                    s.responseType = &quot;css&quot;;
                }
                else if (ext == &quot;mp4&quot;) {
                    s.responseType = &quot;video&quot;;
                }
                else if (ext == &quot;svg&quot;) {
                    s.responseType = &quot;svg&quot;;
                }
                else if (ext == &quot;xml&quot;) {
                    s.responseType = &quot;xml&quot;;
                }
                else if (ext == &quot;json&quot;) {
                    s.responseType = &quot;json&quot;;
                }
                else if (ext == &quot;txt&quot;) {
                    s.responseType = &quot;text&quot;;
                }
                else if (ext == &quot;js&quot; || ext == &quot;swf&quot;) {
                    s.responseType = &quot;js&quot;;
                }
                else {
                    s.responseType = &quot;unKnow&quot;;
                }
            }
            var req = null;
            if (!s._req) {
                s._req = new XMLHttpRequest();
                req = s._req;
                req.withCredentials = false;
                req.onprogress = function (event) {
                    if (!event || event.loaded &gt; 0 &amp;&amp; event.total == 0) {
                        return; // Sometimes we get no &quot;total&quot;, so just ignore the progress event.
                    }
                    s.event(Event.PROGRESS, { loadedBytes: event.loaded, totalBytes: event.total });
                };
                req.onerror = function (event) {
                    reSendTimes++;
                    if (reSendTimes &gt; 3) {
                        s.event(Event.ERROR, { id: 2, msg: event[&quot;message&quot;] });
                    }
                    else {
                        //断线重连
                        req.abort();
                        if (!s.data) {
                            req.send();
                        }
                        else {
                            if (contentType == &quot;form&quot;) {
                                req.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=UTF-8&quot;);
                                req.send(s._fqs(s.data, null));
                            }
                            else {
                                var type = &quot;application/json&quot;;
                                if (contentType != &quot;json&quot;) {
                                    type = &quot;multipart/form-data&quot;;
                                }
                                req.setRequestHeader(&quot;Content-type&quot;, type + &quot;;charset=UTF-8&quot;);
                                req.send(s.data);
                            }
                        }
                    }
                };
                req.onreadystatechange = function (event) {
                    var t = event.target;
                    if (t[&quot;readyState&quot;] == 4) {
                        if (req.status == 200) {
                            var e = new Event();
                            e.setTo(Event.COMPLETE, s, s);
                            try {
                                var result = t[&quot;response&quot;];
                                e.data = { type: s.responseType, response: null };
                                var item = void 0;
                                switch (s.responseType) {
                                    case &quot;css&quot;:
                                        item = document.createElement(&quot;link&quot;);
                                        item.rel = &quot;stylesheet&quot;;
                                        item.href = s.url;
                                        break;
                                    case &quot;image&quot;:
                                        item = new laya.resource.Texture();
                                        item.load(s.url);
                                        break;
                                    case &quot;sound&quot;:
                                    case &quot;video&quot;:
                                        var itemObj;
                                        var isBlob_1 = true;
                                        if (s.responseType == &quot;sound&quot;) {
                                            itemObj = document.createElement(&quot;AUDIO&quot;);
                                        }
                                        else if (s.responseType == &quot;video&quot;) {
                                            itemObj = document.createElement(&quot;VIDEO&quot;);
                                        }
                                        itemObj.preload = true;
                                        itemObj.load();
                                        itemObj.onloadeddata = function () {
                                            if (isBlob_1) {
                                            }
                                            itemObj.onloadeddata = null;
                                        };
                                        try {
                                            itemObj.src = URL.createObjectURL(result);
                                        }
                                        catch (err) {
                                            isBlob_1 = false;
                                            itemObj.src = s.url;
                                        }
                                        if (s.responseType == &quot;sound&quot;) {
                                            item = new annie.Sound(itemObj);
                                        }
                                        else {
                                            item = new annie.Video(itemObj);
                                        }
                                        break;
                                    case &quot;json&quot;:
                                        item = JSON.parse(result);
                                        break;
                                    case &quot;js&quot;:
                                        item = &quot;JS_CODE&quot;;
                                        annie.Eval(result);
                                        break;
                                    case &quot;text&quot;:
                                    case &quot;unKnow&quot;:
                                    case &quot;xml&quot;:
                                    default:
                                        item = result;
                                        break;
                                }
                                e.data[&quot;response&quot;] = item;
                                s.data = null;
                                s.responseType = &quot;&quot;;
                            }
                            catch (e) {
                                s.event(Event.ERROR, { id: 1, msg: &quot;服务器返回信息有误&quot; });
                            }
                            s.event(e.type, e);
                        }
                        else {
                            //服务器返回报错
                            s.event(Event.ERROR, { id: 0, msg: &quot;访问地址不存在&quot; });
                        }
                    }
                };
            }
            else {
                req = s._req;
            }
            var reSendTimes = 0;
            if (s.data &amp;&amp; s.method.toLocaleLowerCase() == &quot;get&quot;) {
                s.url = s._fus(url, s.data);
                s.data = null;
            }
            else {
                s.url = url;
            }
            if (s.responseType == &quot;image&quot; || s.responseType == &quot;sound&quot; || s.responseType == &quot;video&quot;) {
                req.responseType = &quot;blob&quot;;
            }
            else {
                req.responseType = &quot;text&quot;;
            }
            req.open(s.method, s.url, true);
            if (s.headers.length &gt; 0) {
                for (var h = 0; h &lt; s.headers.length; h += 2) {
                    req.setRequestHeader(s.headers[h], s.headers[h + 1]);
                }
                s.headers.length = 0;
            }
            if (!s.data) {
                req.send();
            }
            else {
                if (contentType == &quot;form&quot;) {
                    req.setRequestHeader(&quot;Content-type&quot;, &quot;application/x-www-form-urlencoded;charset=UTF-8&quot;);
                    req.send(s._fqs(s.data, null));
                }
                else {
                    var type = &quot;application/json&quot;;
                    if (contentType != &quot;json&quot;) {
                        type = &quot;multipart/form-data&quot;;
                    }
                    req.setRequestHeader(&quot;Content-type&quot;, type + &quot;;charset=UTF-8&quot;);
                    req.send(s.data);
                }
            }
            /*req.onloadstart = function (e) {
             s.event(&quot;onStart&quot;);
             };*/
        };
        /**
         * 添加自定义头
         * @addHeader
         * @param name
         * @param value
         */
        URLLoader.prototype.addHeader = function (name, value) {
            this.headers.push(name, value);
        };
        return URLLoader;
    }(EventDispatcher));
    annie.URLLoader = URLLoader;
})(annie || (annie = {}));

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
